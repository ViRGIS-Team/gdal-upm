name: Build GDAL AAR (multi-ABI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip ninja-build cmake git curl build-essential

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Clone vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.sh

      - name: Build GDAL with vcpkg for supported ABIs
        run: |
          ./vcpkg/vcpkg install gdal:arm64-android
          ./vcpkg/vcpkg install gdal:x64-android
          ./vcpkg/vcpkg install gdal:x86-android
          ./vcpkg/vcpkg integrate install

      - name: Create Android Library project
        run: |
          mkdir -p android-gdal/libs/arm64-v8a
          mkdir -p android-gdal/libs/x86_64
          mkdir -p android-gdal/libs/x86

          cp ./vcpkg/installed/arm64-android/lib/libgdal.so android-gdal/libs/arm64-v8a/
          cp ./vcpkg/installed/x64-android/lib/libgdal.so android-gdal/libs/x86_64/
          cp ./vcpkg/installed/x86-android/lib/libgdal.so android-gdal/libs/x86/

          cp -r ./vcpkg/installed/arm64-android/include android-gdal/include

          # settings.gradle
          cat > android-gdal/settings.gradle <<'EOF'
          rootProject.name = "gdal-android"
          EOF

          # gradle.properties
          cat > android-gdal/gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # build.gradle
          cat > android-gdal/build.gradle <<'EOF'
          plugins {
              id 'com.android.library'
              id 'maven-publish'
          }

          android {
              namespace "org.gdal"
              compileSdkVersion 34
              ndkVersion "26.1.10909125"

              defaultConfig {
                  minSdkVersion 21
                  targetSdkVersion 34
                  externalNativeBuild {
                      cmake {
                          cppFlags ""
                      }
                  }
                  ndk {
                      abiFilters "arm64-v8a", "x86_64", "x86"
                  }
              }
              externalNativeBuild {
                  cmake {
                      path "CMakeLists.txt"
                  }
              }
              publishing {
                  singleVariant("release")
              }
          }

          publishing {
              publications {
                  release(MavenPublication) {
                      groupId = "com.github.\${System.getenv('GITHUB_REPOSITORY_OWNER')}"
                      artifactId = "gdal-android"
                      version = "1.0.0"
                      afterEvaluate {
                          from components.release
                      }
                  }
              }
              repositories {
                  maven {
                      name = "GitHubPackages"
                      url = uri("https://maven.pkg.github.com/${{ github.repository }}")
                      credentials {
                          username = System.getenv("GITHUB_ACTOR")
                          password = System.getenv("GITHUB_TOKEN")
                      }
                  }
              }
          }
          EOF

          # CMakeLists.txt
          cat > android-gdal/CMakeLists.txt <<'EOF'
          cmake_minimum_required(VERSION 3.15)
          project(gdal-android)
