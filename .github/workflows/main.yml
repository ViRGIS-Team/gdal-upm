name: Build GDAL AAR (arm64-v8a cached)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip ninja-build cmake git curl build-essential

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Clone vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.sh

      - name: Restore vcpkg binary cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/vcpkg
          key: vcpkg-bincache-${{ runner.os }}-arm64-android-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-bincache-${{ runner.os }}-arm64-android-

      - name: Add custom triplet for shared libs
        run: |
          mkdir -p vcpkg/triplets
          cat > vcpkg/triplets/arm64-android-dynamic.cmake <<'EOF'
          set(VCPKG_TARGET_ARCHITECTURE arm64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_CMAKE_SYSTEM_NAME Android)
          set(VCPKG_CMAKE_SYSTEM_VERSION 21) # match minSdkVersion
          # Chainload the Android NDK toolchain so vcpkg/CMake detects the NDK compiler correctly
          if(NOT DEFINED ENV{ANDROID_NDK_HOME})
            message(FATAL_ERROR "ANDROID_NDK_HOME must be set in environment")
          endif()
          set(VCPKG_CHAINLOAD_TOOLCHAIN_FILE "$ENV{ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake")
          set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -DOPENSSL_NO_EC_NISTP_64_GCC_128=0")
          set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DOPENSSL_NO_EC_NISTP_64_GCC_128=0")
          EOF

      - name: Build GDAL with vcpkg (arm64-v8a shared)
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/26.1.10909125}
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          # Use the NDK clang wrappers for the target API level 21
          export CC=aarch64-linux-android21-clang
          export CXX=aarch64-linux-android21-clang++
          export VCPKG_CHAINLOAD_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake"
          export VCPKG_DEFAULT_TRIPLET=arm64-android-dynamic
          ./vcpkg/bootstrap-vcpkg.sh
          ./vcpkg/vcpkg install gdal --triplet=arm64-android-dynamic
          ./vcpkg/vcpkg integrate install

      - name: Create Android Library project
        run: |
          mkdir -p android-gdal/libs/arm64-v8a
          cp ./vcpkg/installed/arm64-android/lib/*.so android-gdal/libs/arm64-v8a/
          cp -r ./vcpkg/installed/arm64-android/include android-gdal/include

          # settings.gradle
          cat > android-gdal/settings.gradle <<'EOF'
          rootProject.name = "gdal-android"
          EOF

          # gradle.properties
          cat > android-gdal/gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # build.gradle
          cat > android-gdal/build.gradle <<'EOF'
          plugins {
              id 'com.android.library'
              id 'maven-publish'
          }

          android {
              namespace "org.gdal"
              compileSdkVersion 34
              ndkVersion "26.1.10909125"

              defaultConfig {
                  minSdkVersion 21
                  targetSdkVersion 34
                  externalNativeBuild {
                      cmake {
                          cppFlags ""
                      }
                  }
                  ndk {
                      abiFilters "arm64-v8a"
                  }
              }
              externalNativeBuild {
                  cmake {
                      path "CMakeLists.txt"
                  }
              }
              publishing {
                  singleVariant("release")
              }
          }

          publishing {
              publications {
                  release(MavenPublication) {
                      groupId = "com.github.${System.getenv('GITHUB_REPOSITORY_OWNER')}"
                      artifactId = "gdal-android"
                      version = "1.0.0"
                      afterEvaluate {
                          from components.release
                      }
                  }
              }
              repositories {
                  maven {
                      name = "GitHubPackages"
                      url = uri("https://maven.pkg.github.com/${{ github.repository }}")
                      credentials {
                          username = System.getenv("GITHUB_ACTOR")
                          password = System.getenv("GITHUB_TOKEN")
                      }
                  }
              }
          }
          EOF

          # CMakeLists.txt
          cat > android-gdal/CMakeLists.txt <<'EOF'
          cmake_minimum_required(VERSION 3.15)
          project(gdal-android)

          add_library(gdal SHARED IMPORTED)

          set_target_properties(gdal PROPERTIES
              IMPORTED_LOCATION ${CMAKE_SOURCE_DIR}/libs/arm64-v8a/libgdal.so
              INTERFACE_INCLUDE_DIRECTORIES ${CMAKE_SOURCE_DIR}/include
          )

          add_library(gdalwrapper SHARED gdalwrapper.cpp)
          target_link_libraries(gdalwrapper gdal)
          EOF

          # Simple JNI wrapper
          cat > android-gdal/gdalwrapper.cpp <<'EOF'
          #include <jni.h>
          #include "gdal.h"

          extern "C"
          JNIEXPORT jstring JNICALL
          Java_org_gdal_Gdal_version(JNIEnv* env, jobject) {
              const char* ver = GDALVersionInfo("RELEASE_NAME");
              return env->NewStringUTF(ver);
          }
          EOF

      - name: Generate Gradle Wrapper
        run: |
          cd android-gdal
          gradle wrapper --gradle-version 8.6

      - name: Build AAR
        run: |
          cd android-gdal
          ./gradlew assembleRelease publish

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal-aar
          path: android-gdal/build/outputs/aar/*.aar
